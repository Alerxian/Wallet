# Mobile Rewrite Design Document (Final)

## 1) Current-State Diagnosis

- Legacy implementation concentrated most business logic, data fetching, wallet flow, and UI rendering in one heavy layer.
- Feature coupling made lifecycle behavior fragile: auth, tab changes, market detail updates, and pending polling were tightly intertwined.
- UI lacked a coherent design system and strong visual direction; component reuse was limited.
- API behavior was not normalized into a strict contract layer, making response drift handling costly.

## 2) Refactor Options + Recommendation

### Option A: Layered Modular Frontend (Recommended)

- Stack: `React Native + Expo + zustand + ky + zod`
- Boundaries: `app/components/screens/hooks/services/api/state/utils/theme`
- Pros: low risk migration, fast maintainability gain, clear ownership boundaries
- Cons: still app-level orchestration, not full DDD

### Option B: Feature-Sliced Architecture

- Organize by entities/features/widgets/pages/shared
- Pros: stronger domain segmentation for large teams
- Cons: high rewrite complexity for MVP scope

### Option C: Data-query-centric architecture

- Center state on query/cache layer and derived UI
- Pros: strong request dedup/invalidation model
- Cons: extra abstraction and migration overhead

### Final Choice

Use **Option A** now and keep clear extension points for feature-sliced evolution later.

## 3) Recommended Directory Structure

```txt
mobile/
  App.tsx
  src/
    app/
      MainApp.tsx
    api/
      client.ts
      schemas.ts
    components/
      shell/
        HeaderBar.tsx
        BottomDock.tsx
    config/
      env.ts
    domain/
      types.ts
    hooks/
      useAppController.ts
    screens/
      MarketsTab.tsx
      PortfolioTab.tsx
      ActivityTab.tsx
      SettingsTab.tsx
    services/
      backend.ts
      walletconnect.ts
      storage.ts
    state/
      store.ts
    theme/
      design.ts
    utils/
      common.ts
      wallet.ts
      siwe.ts
      trade.ts
      *.test.ts
```

## 4) UI/UX Redesign Plan

- Visual direction: **Bold Trading Desk** (dark neutral base + amber accent + explicit risk/success colors).
- Top header: branded desk identity + wallet state capsule + connect/logout action.
- Bottom tabs: `MARKETS`, `PORTFOLIO`, `ACTIVITY`, `SETTINGS` as primary navigation.
- Markets:
  - strong hero panel
  - high-contrast market cards with status chips
  - detail ticket with yes/no pool and order controls
- Trade panel:
  - explicit YES/NO side switch
  - amount input and dual CTA (buy/sell)
  - loading/disabled behavior on async operations
- Activity:
  - merged pending + indexed stream with state chips
- Settings:
  - network/session/wallet diagnostics and recent error feed

## 5) Data Flow & State Management

- `ky` handles transport, timeout, auth header injection, and HTTP status checks.
- `zod` validates all backend responses before entering application state.
- `zustand` central store tracks UI state, auth/session state, markets/trades data, and runtime errors.
- `useAppController` orchestrates side effects:
  - hydration + session restore
  - wallet connect/recover flow
  - SIWE nonce/sign/verify
  - polling pending transaction status
  - refresh data on indexed completion
- Sensitive credentials are persisted with `SecureStore`; non-sensitive UI preferences use `AsyncStorage`.

## 6) Phased Migration Plan (Steps, Risk, Rollback)

### Phase 1: Shell + New Runtime

- Build app shell, tab system, theme tokens, store skeleton.

### Phase 2: API/Service Layer

- Add typed backend adapters and wallet adapter.

### Phase 3: Feature Screens

- Rebuild markets/portfolio/activity/settings from scratch.

### Phase 4: Runtime Hardening

- Wire auth lifecycle, session recovery, pending polling, error boundaries.

### Phase 5: Validation

- Run typecheck + unit tests + manual smoke checklist.

Risks:

- Wallet relay instability and wallet app deep-link inconsistencies.
- Session recovery race at app foreground.
- Polling loops duplication if lifecycle guards regress.

Rollback:

- Keep changes modular by layer so each phase can be reverted independently.

## 7) Executable Task List (Modular)

- App shell and navigation scaffold
- Theme tokens and visual grammar
- API contracts (`ky` + `zod`)
- Service adapters (backend/wallet/storage)
- Global state and mutation actions (`zustand`)
- Runtime orchestration hook
- Markets tab + detail ticket
- Portfolio tab
- Activity tab
- Settings tab
- Docs and quality gates

## 8) Mandatory Tests (Must pass before stop)

- `npm run typecheck`
- `npm run test`

Unit tests required:

- Wallet chain/account parsing
- SIWE message construction fields
- Trade amount validation
- Pending/history merge and dedup logic

Manual smoke required:

- Connect wallet
- SIWE authentication
- Market detail buy/sell submission
- Activity updates and pending->indexed transitions
- Logout and session recovery behavior

Stop condition: all mandatory checks pass.
