# Prediction Market App 详细需求文档（参考 Opinion / Polymarket）

版本：v1.0  
更新时间：2026-02-18  
适用端：React Native / Expo（iOS / Android）

---

## 1. 文档目标

本文件用于定义移动端产品的完整需求边界、交互细节、验收标准与阶段目标，指导后续实现与测试。

目标是打造一个“可发现 - 可交易 - 可跟踪 - 可复盘”的预测市场体验，参考 Opinion / Polymarket 的成熟能力，但适配当前项目的技术与业务约束。

---

## 2. 产品定位与对标策略

### 2.1 产品定位

- 面向对事件概率交易有兴趣的用户，提供低门槛、快速反馈的移动端交易体验。
- 核心价值：
  - 快速发现有价值市场
  - 低操作成本完成买卖
  - 实时跟踪头寸与交易状态
  - 在弱网和链上延迟场景下依然可感知、可恢复

### 2.2 对标能力（Opinion / Polymarket）

- 市场发现：搜索、分类、排序、热门与近期板块
- 市场详情：概率/池子信息清晰、交易入口直达
- 交易体验：快捷金额、风险提示、提交后状态可追踪
- 资产中心：持仓汇总 + 历史记录 + 状态标签
- 用户留存：收藏市场、最近浏览、更强回访路径

### 2.3 本项目约束

- 现有核心能力必须保持可用：市场列表、详情、买卖、WalletConnect 登录、持仓、活动流
- TypeScript 持续使用
- 状态管理保持轻量（zustand）
- API 保持兼容（ky + zod）

---

## 3. 目标用户与典型场景

### 3.1 用户分层

1. 新手用户
- 特征：第一次接触预测市场，关注“看得懂、下得快、风险可知”
- 关键诉求：直观解释、少步骤交易、明确错误提示

2. 高频用户
- 特征：每日多次查看市场与仓位
- 关键诉求：高效率筛选、快速下单、状态更新快

3. 观察型用户
- 特征：先看不买，偏研究
- 关键诉求：收藏、最近浏览、信息组织清晰

### 3.2 核心用户旅程

旅程 A：发现并交易
1) 打开市场页  
2) 搜索/筛选目标市场  
3) 进入详情页  
4) 输入金额并买入/卖出  
5) 查看交易状态  

旅程 B：复盘与回访
1) 打开资产/活动页  
2) 查看持仓变化与交易状态  
3) 回到收藏市场继续跟踪  

---

## 4. 信息架构与导航

底部 Tab 维持四大入口：

- MARKETS：市场发现与交易入口
- PORTFOLIO：仓位与汇总
- ACTIVITY：交易时间线
- SETTINGS：钱包、网络、会话、诊断信息

跨页全局能力：

- 收藏（Watchlist）
- 最近浏览（Recent）
- 统一错误提示（可追溯）

---

## 5. 功能需求（详细）

## 5.1 市场发现（Markets List）

### 5.1.1 展示要求

- 列表卡片字段：
  - 市场 ID
  - 问题标题
  - 状态（OPEN/CLOSED/RESOLVED）
  - 关闭时间
  - 市场地址（详情页可见）
- 首屏必须支持下拉刷新
- 加载态：骨架屏或 loading indicator
- 空态：给出可操作建议（清除筛选/重试）

### 5.1.2 搜索

- 支持按问题文本关键字模糊匹配
- 搜索应在本地列表即时响应（客户端过滤）
- 输入防抖：200-300ms

### 5.1.3 筛选

- 状态筛选：全部 / OPEN / CLOSED / RESOLVED
- 时间筛选：即将关闭 / 已结束
- 收藏筛选：仅看收藏

### 5.1.4 排序

- 默认排序：最近关闭时间优先（可配置）
- 可选排序：
  - 关闭时间升序
  - 关闭时间降序
  - ID 新到旧

### 5.1.5 收藏与最近浏览

- 每张卡片支持收藏/取消收藏
- 点击进入详情时记录最近浏览（最多 8-20 条）
- 收藏与最近浏览本地持久化（AsyncStorage）

### 5.1.6 验收标准

- 搜索输入后 300ms 内列表更新
- 筛选与排序可叠加生效
- 收藏状态刷新后保持不丢失
- 最近浏览在重启 App 后可恢复

---

## 5.2 市场详情（Market Detail）

### 5.2.1 信息区

- 展示市场问题、状态、地址、关闭时间
- 展示 YES/NO 池子（若后端可用）
- 信息缺失时给出 fallback 文案，不出现空白块

### 5.2.2 交易入口区

- 交易方向切换：YES / NO
- 金额输入：仅数值，支持小数
- 快捷金额：5 / 10 / 25 / 50 / 100（可配置）
- 预计结果信息（若可计算）：
  - 提交金额
  - 操作方向
  - 预估说明（静态提示或后端返回）

### 5.2.3 交互要求

- 未连接钱包时点击交易，弹明确引导
- 网络不匹配时，提示切换网络
- 金额非法时禁用提交按钮并提示

### 5.2.4 验收标准

- 详情信息加载成功率 > 99%（可重试）
- 所有关键错误有可理解文案
- 提交按钮在非法输入下不可点击

---

## 5.3 交易流程（Buy/Sell）

### 5.3.1 提交流程

1. 前置校验
- 钱包已连接
- 会话未过期
- 网络符合预期（如 31337）
- 输入金额 > 0

2. 提交交易
- BUY 时如需授权，先走 APPROVE，再走 TRADE
- 交易提交后写入本地 pending

3. 状态追踪
- 定时刷新 pending 状态（PENDING / CONFIRMED / INDEXED / FAILED）
- INDEXED 后触发市场、持仓、历史刷新

### 5.3.2 用户反馈

- 提交中：按钮 loading，防重复点击
- 提交成功：toast/alert + 跳转 Activity
- 提交失败：错误原因 + 重试入口

### 5.3.3 风险控制

- 同一笔操作的重复提交保护
- 钱包连接抖动时的容错重试
- 链上超时提示与后续状态补偿

### 5.3.4 验收标准

- 无效前置条件不会触发真实交易
- 交易状态能从 pending 跟踪到终态
- 失败交易可追溯具体错误

---

## 5.4 资产页（Portfolio）

### 5.4.1 展示内容

- 持仓列表：问题、状态、YES/NO 持仓、池子信息
- 汇总卡片：
  - 持仓市场数
  - 总持仓份额（如可计算）
  - 活跃头寸数

### 5.4.2 交互能力

- 下拉刷新
- 从持仓项快速跳转对应市场详情

### 5.4.3 验收标准

- 已认证用户可稳定加载持仓
- 空持仓状态文案清晰

---

## 5.5 活动页（Activity）

### 5.5.1 展示内容

- 合并视图：本地 pending + 后端历史
- 每条记录展示：市场、动作、方向、金额、状态、tx hash

### 5.5.2 筛选能力

- 状态筛选：全部 / PENDING / CONFIRMED / INDEXED / FAILED
- 动作筛选：BUY / SELL

### 5.5.3 交互能力

- 点击 tx hash 可复制（可选）
- 失败记录支持快速重试（跳回详情并带入参数）

### 5.5.4 验收标准

- 列表顺序与时间一致（最新在前）
- 相同 tx 不重复展示

---

## 5.6 钱包与会话（Settings + Header）

### 5.6.1 钱包连接

- 支持连接、重连、登出
- 显示连接阶段文本（Init/Pairing/Approval/...）
- Relay 异常时自动降级重试一次

### 5.6.2 会话管理

- token 持久化与过期检测
- App 回前台时尝试恢复 session
- 会话过期时统一清理并提示

### 5.6.3 诊断信息

- 显示 backend 地址、网络、连接状态
- 最近错误列表（最多 N 条）

### 5.6.4 验收标准

- 冷启动可恢复有效会话
- 过期会话不会继续访问受保护接口

---

## 6. 数据与状态需求

### 6.1 全局状态（zustand）

- 基础：tab、wallet、auth、errors
- 市场域：markets、selectedMarketId、marketDetail
- 交易域：tradeAmount、tradeSide、pendingTxs
- 增强域：watchlistIds、recentMarketIds、activityFilters

### 6.2 本地持久化

- AsyncStorage：tab、wallet、watchlist、recent
- SecureStore：authToken、authExpiresAt

### 6.3 失效与同步策略

- 交易状态变化触发相关数据刷新
- 切 tab 时按需加载，避免无意义请求风暴
- 弱网下允许重试并保留最后成功快照（可选）

---

## 7. API 与兼容要求

保持现有接口兼容，新增需求优先使用客户端组合实现。

### 7.1 已有接口（必须）

- `GET /markets`
- `GET /markets/:id`
- `GET /positions/:wallet`
- `GET /history/:wallet`
- `POST /trades/approve-intent`
- `POST /trades/intent`
- `GET /trades/status/:txHash`
- `GET /auth/nonce`
- `POST /auth/verify-siwe`
- `GET /auth/session`
- `POST /auth/logout`

### 7.2 可选新增接口（P1/P2）

- 服务端搜索/筛选接口（当市场规模增大时）
- 收藏市场云同步接口（多端一致）

---

## 8. UI/UX 详细规范

### 8.1 视觉方向

- 风格关键词：专业、信息密度适中、交易导向
- 配色：保持高对比，不强依赖暗色
- 字体：标题强识别，正文保证可读性

### 8.2 组件规范

- 统一卡片：边框、圆角、阴影层级
- 统一按钮：主按钮/次按钮/危险按钮
- 统一状态标签：PENDING/CONFIRMED/FAILED 等
- 统一输入框：错误态、聚焦态、禁用态

### 8.3 动效规范

- 列表首屏渐入
- 状态切换轻量过渡（150-250ms）
- 禁止过量动画影响效率

### 8.4 可访问性

- 触控区 >= 44x44
- 文本对比度达到可读标准
- 状态不只靠颜色表达（同时提供文本）

---

## 9. 异常与边界场景

### 9.1 弱网/断网

- 请求失败给出重试按钮
- 保留最后一次成功数据（可选）
- 明确“当前为离线/网络不稳定”状态提示

### 9.2 钱包中断

- deep link 打开失败时提示手动操作
- approval 超时提示并允许重试

### 9.3 链上状态延迟

- 已提交未索引时提示“稍后刷新”
- 不把链上延迟误导成失败

### 9.4 数据异常

- 字段缺失时展示 fallback 文案
- schema 校验失败时记录诊断错误并提示用户重试

---

## 10. 埋点与运营指标（建议）

### 10.1 关键事件埋点

- `app_open`
- `wallet_connect_start/success/fail`
- `market_search`
- `market_filter_apply`
- `market_open_detail`
- `trade_submit_start/success/fail`
- `trade_status_indexed`
- `watchlist_add/remove`

### 10.2 指标目标（首期）

- 交易提交成功率 >= 95%（排除链外不可控）
- 关键页面崩溃率 < 0.5%
- 市场页首次可交互时间 < 2.0s（本地测试环境）

---

## 11. 非功能需求

### 11.1 性能

- 列表滑动稳定，无明显掉帧
- 切 tab 延迟可接受（< 300ms 感知）

### 11.2 安全

- 不打印敏感 token
- 会话过期后立即清理
- 错误信息不泄露私密数据

### 11.3 可维护性

- 业务逻辑集中在 hooks/services
- UI 组件可复用，不在 screen 内堆砌复杂逻辑

---

## 12. 分阶段实施建议

### Phase 1（P0）- 高价值基础增强

- 市场搜索/筛选/排序
- 收藏 + 最近浏览（本地持久化）
- 交易快捷金额与提交前校验完善
- Activity 状态筛选

验收：核心功能无回归 + 新增功能全链路可用

### Phase 2（P1）- 体验与效率提升

- Portfolio 汇总卡片
- 失败交易快速重试入口
- 更完整的加载态/空态/错误态

验收：回访效率与可理解性明显提升

### Phase 3（P2）- 进阶能力

- 可选图表模块（概率/池子变化）
- 通知提醒（价格/状态变化，若后端支持）
- 收藏云同步（若后端支持）

验收：增强留存与长期使用价值

---

## 13. 测试用例清单（必须通过）

### 13.1 单元测试

- 金额校验函数
- Activity 合并去重逻辑
- 搜索/筛选/排序纯函数
- 收藏与最近浏览持久化读写

### 13.2 集成测试

- 市场列表 -> 详情 -> 下单 -> 活动追踪
- 登录态恢复与过期清理
- pending 到 indexed 的刷新联动

### 13.3 手工回归

- 未登录状态下所有入口提示是否正确
- 弱网下重试行为是否可用
- 交易失败提示是否可理解
- 收藏与最近浏览跨重启是否生效

### 13.4 通过门禁

- `npm run typecheck`
- `npm run test`

不满足门禁不得结束任务。

---

## 14. 验收标准（DoD）

当且仅当以下全部满足，需求视为完成：

- 核心链路（发现 -> 交易 -> 跟踪）可稳定走通
- P0 增强功能全部上线并通过回归
- 错误与边界场景有明确反馈
- typecheck 与 test 全绿
- 文档与实现一致

---

## 15. 默认假设（Assumptions）

- 当前后端接口与 schema 保持稳定
- 市场规模在移动端可先用客户端过滤满足
- 收藏与最近浏览首期仅本地持久化即可
- 图表与通知能力可放在 P2，不阻塞 P0/P1 上线

---

## 16. 非目标（本期不做）

- 复杂衍生品策略交易
- 社交评论系统
- 多链跨链统一资产视图
- 高级量化图表系统

---

## 17. 交付物清单

- 产品需求文档（本文件）
- 阶段实施清单（2.md）
- 最终验收报告模板（3.md）
- 生产化路线图（production-roadmap-2-4-8-weeks.md）
- Week 1 实施任务单（week1-implementation-checklist.md）

本文件为后续所有实现与验收的主需求依据。
